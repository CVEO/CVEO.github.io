---
import BaseLayout from '../layouts/BaseLayout.astro'
import PatentTable from '../components/PatentTable/index.astro'
import PaperCard from '../components/PaperCard.astro'
import awardsData from '../data/awards.json'
import { getCollection } from 'astro:content'
import { loadPatents } from '../lib/data/patents'

const patentsData = await loadPatents()

const allPapers = (await getCollection('papers') || []).sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});
const ourPapers = allPapers.filter(p => p.id.startsWith('our/'))
const collaborativePapers = allPapers.filter(p => p.id.startsWith('collaborative/'))
---
<BaseLayout title="科研成果">
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
      <h1 class="text-3xl font-bold text-slate-900">科研成果</h1>
      
      <div class="inline-flex p-1 bg-slate-100 rounded-xl" id="paper-tabs">
        <button 
          type="button"
          class="px-6 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-white text-brand-900 shadow-sm"
          data-tab="our"
        >
          通讯/一作论文
        </button>
        <button 
          type="button"
          class="px-6 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-slate-600 hover:text-slate-900"
          data-tab="collaborative"
        >
          合作论文
        </button>
      </div>
    </div>

    <div id="paper-content">
      <div id="our-papers" class="grid grid-cols-1 gap-6 paper-list" data-type="our">
        {ourPapers.map((p, index) => (
          <div class="paper-item hidden" data-index={index}>
            <PaperCard paper={p} showAbstract={false} showLink={true} />
          </div>
        ))}
      </div>

      <div id="collaborative-papers" class="grid grid-cols-1 gap-6 paper-list hidden" data-type="collaborative">
        {collaborativePapers.map((p, index) => (
          <div class="paper-item hidden" data-index={index}>
            <PaperCard paper={p} showAbstract={false} showLink={true} />
          </div>
        ))}
      </div>
    </div>

    <!-- Pagination Controls -->
    <div id="pagination" class="mt-12 flex justify-center items-center gap-2">
      <button type="button" id="prev-page" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
        上一页
      </button>
      <div id="page-numbers" class="flex gap-2"></div>
      <button type="button" id="next-page" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
        下一页
      </button>
    </div>

    <div class="mt-20">
      <h2 class="text-2xl font-bold text-slate-900 mb-8 flex items-center">
        <span class="w-8 h-1 bg-brand-600 mr-4"></span>
        专利与软著
      </h2>
      <PatentTable patents={patentsData} />
    </div>
  </section>
</BaseLayout>

<script>
  const tabs = document.querySelectorAll('#paper-tabs button');
  const ourContent = document.getElementById('our-papers');
  const collabContent = document.getElementById('collaborative-papers');
  
  // Pagination State
  const ITEMS_PER_PAGE = 15;
  let currentTab = 'our';
  let currentPage = 1;

  function updatePagination() {
    const activeContent = currentTab === 'our' ? ourContent : collabContent;
    if (!activeContent) return;

    const papers = activeContent.querySelectorAll('.paper-item');
    const totalPages = Math.ceil(papers.length / ITEMS_PER_PAGE);
    
    // Ensure currentPage is within bounds
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    // Show/Hide papers
    papers.forEach((paper, index) => {
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      if (index >= start && index < end) {
        paper.classList.remove('hidden');
      } else {
        paper.classList.add('hidden');
      }
    });

    // Update Page Numbers
    const pageNumbersContainer = document.getElementById('page-numbers');
    if (pageNumbersContainer) {
      pageNumbersContainer.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i.toString();
        btn.className = `px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
          i === currentPage 
            ? 'bg-brand-600 text-white shadow-sm' 
            : 'text-slate-600 hover:bg-slate-100'
        }`;
        btn.onclick = () => {
          currentPage = i;
          updatePagination();
          window.scrollTo({ top: document.getElementById('paper-content')?.offsetTop ? document.getElementById('paper-content')!.offsetTop - 100 : 0, behavior: 'smooth' });
        };
        pageNumbersContainer.appendChild(btn);
      }
    }

    // Update Prev/Next buttons
    const prevBtn = document.getElementById('prev-page') as HTMLButtonElement;
    const nextBtn = document.getElementById('next-page') as HTMLButtonElement;
    if (prevBtn) prevBtn.disabled = currentPage === 1;
    if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
  }

  // Tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-tab');
      if (!target) return;
      
      currentTab = target;
      currentPage = 1; // Reset to first page on tab switch
      
      // Update tab styles
      tabs.forEach(t => {
        t.classList.remove('bg-white', 'text-brand-900', 'shadow-sm');
        t.classList.add('text-slate-600', 'hover:text-slate-900');
      });
      tab.classList.add('bg-white', 'text-brand-900', 'shadow-sm');
      tab.classList.remove('text-slate-600', 'hover:text-slate-900');

      // Update content visibility
      if (currentTab === 'our') {
        ourContent?.classList.remove('hidden');
        collabContent?.classList.add('hidden');
      } else {
        ourContent?.classList.add('hidden');
        collabContent?.classList.remove('hidden');
      }

      updatePagination();
    });
  });

  // Prev/Next handlers
  document.getElementById('prev-page')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
      window.scrollTo({ top: document.getElementById('paper-content')?.offsetTop ? document.getElementById('paper-content')!.offsetTop - 100 : 0, behavior: 'smooth' });
    }
  });

  document.getElementById('next-page')?.addEventListener('click', () => {
    const activeContent = currentTab === 'our' ? ourContent : collabContent;
    const totalPapers = activeContent?.querySelectorAll('.paper-item').length || 0;
    const totalPages = Math.ceil(totalPapers / ITEMS_PER_PAGE);
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
      window.scrollTo({ top: document.getElementById('paper-content')?.offsetTop ? document.getElementById('paper-content')!.offsetTop - 100 : 0, behavior: 'smooth' });
    }
  });

  // Initial call
  updatePagination();
</script>
